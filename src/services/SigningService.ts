import axios from 'axios';
import KJUR from 'jsrsasign';
import { onError } from './ErrorService';

export const downloadAndVerifySigning = (url: string) => new Promise<any>(async (resolve, reject) => {
  try {
    const { data }: { data: string } = await axios.get(`${url}.sign?r=${Math.random()}`, { headers: { 'Content-Type': 'application/json;charset=utf-8' } });

    const curve = 'secp256r1';
    const sigalg = 'SHA256withECDSA';
    const pubkey = '04c9635247abc25e9edf80bbebaa0ed74b4c4febeff3237787fb86d675a9f8dd878f9ec5d91fd4219496192ee10ed3daa36df2acf966a1bd9df7ee3d1c299f3260';

    const signatureLength = data.indexOf('{');

    if (signatureLength >= 0) {
      const signature = data.slice(0, signatureLength);
      
      const jsonB64 = data.slice(signatureLength);
      
      // @ts-ignore
      const sig = new KJUR.crypto.Signature({ alg: sigalg, prov: 'cryptojs/jsrsa' });
      
      sig.init({ xy: pubkey, curve });
      
      sig.updateString(jsonB64);
      
      const result = sig.verify(signature);
      
      if (result) {
        const json = JSON.parse(jsonB64);
        
        resolve(json);
      } else {
        reject('invalid ECDSA signature');
      }
    } else {
      reject('no content');
    }
  } catch (error) {
    reject(error);
    onError({ error });
  }
});
